h1. Заметки о релизе Ruby on Rails 4.0

Ключевые новинки в Rails 4.0:

Эти заметки о релизе покрывают основные обновления, но не включают все мелкие багфиксы и изменения. Чтобы увидеть все, обратитесь к "списку комитов":https://github.com/rails/rails/commits/master в главном репозитории Rails на GitHub.

h3. Обновление до Rails 4.0

TODO. Это руководство все еще в разработке.

Если обновляете существующее приложение, было бы хорошо иметь перед этим покрытие тестами. Также, до попытки обновиться до Rails 4.0, необходимо сначала обновиться до Rails 3.2 и убедиться, что приложение все еще выполняется так, как нужно. Затем нужно предпринять следующие изменения:

h4. Rails 4.0 требует как минимум Ruby 1.9.3

Rails 4.0 требует Ruby 1.9.3 или выше. Поддержка всех прежних версий Ruby была официально прекращена, и следует обновиться как можно быстрее.

h4. Что обновить в приложении

* Обновите зависимости в вашем Gemfile
** <tt>rails = 4.0.0</tt>
** <tt>sass-rails ~> 3.2.3</tt>
** <tt>coffee-rails ~> 3.2.1</tt>
** <tt>uglifier >= 1.0.3</tt>

TODO: Update the versions above.

* Rails 4.0 полностью убирает <tt>vendor/plugins</tt>. Следует переместить эти плагины, выделяя их в гемы и добавляя в свой Gemfile. Если вы не хотите делать из них гемы, можно их переместить, скажем в <tt>lib/my_plugin/*</tt>, и добавить соответствующий инициализатор в <tt>config/initializers/my_plugin.rb</tt>.

TODO: Configuration changes in environment files

h3. Создание приложения Rails 4.0

<shell>
# Необходим установленный рубигем 'rails'
$ rails new myapp
$ cd myapp
</shell>

h4. Сторонние гемы

Сейчас Rails использует +Gemfile+ в корне приложения, чтобы определить гемы, требуемые для запуска вашего приложения. Этот +Gemfile+ обрабатывается "Bundler":http://github.com/carlhuda/bundler, который затем устанавливает все зависимости. Он может даже установить все зависимости локально в ваше приложение, и оно не будет зависеть от системных гемов.

Подробнее: - "Bundler homepage":http://gembundler.com

h4. Живите на грани

+Bundler+ и +Gemfile+ замораживает ваше приложение Rails с помощью новой отдельной команды <tt>bundle</tt>. Если хотите установить напрямую из репозитория Git, передайте флажок +--edge+:

<shell>
$ rails new myapp --edge
</shell>

Если у вас есть локальная копия репозитория Rails, и вы хотите создать приложение с ее использованием, передайте флажок +--dev+:

<shell>
$ ruby /path/to/rails/railties/bin/rails new myapp --dev
</shell>

h3. Основные особенности

h3. Документация

h3. Railties

* Позволяет генераторам скаффолда/модели/миграции принимать модификатор <tt>polymorphic</tt> для <tt>references</tt>/<tt>belongs_to</tt>, например

<shell>
rails g model Product supplier:references{polymorphic}
</shell>

создаст модель со связью <tt>belongs_to :supplier, polymorphic: true</tt> и соответствующей миграцией.

* Устанавливает для среды development <tt>config.active_record.migration_error</tt> как <tt>:page_load</tt>.

* В <tt>Rails::Railtie</tt> добавлен runner в качестве хука, вызываемого только после запуска runner.

* Добавляет путь <tt>/rails/info/routes</tt>, который отображает ту же информацию, что и +rake routes+.

* Улучшает вывод +rake routes+ для редиректов.

* Загружает все доступные среды в <tt>config.paths["config/environments"]</tt>.

* Генератор приложения создает <tt>public/humans.txt</tt> с некоторыми базовыми данными.

* Добавляет <tt>config.queue_consumer</tt> чтобы позволить настройку потребителя очереди по умолчанию.

* Добавляет <tt>Rails.queue</tt> как интерфейс с реализацией по умолчанию, выполняющей работы в отдельном треде.

* Убирает <tt>Rack::SSL</tt> в пользу <tt>ActionDispatch::SSL</tt>.

* Позволяет установить класс, оторый будет использован для запуска в качестве консоли, иной, чем IRB, с помощью <tt>Rails.application.config.console=</tt>. Лучше всего ее добавить в блок console.

<ruby>
# это будет добавлено в config/application.rb
console do
  # этот блок вызывается только при запуске консоли,
  # поэтому можно тут безопасно вызвать pry
  require "pry"
  config.console = Pry
end
</ruby>

* Добавляет удобный метод <tt>hide!</tt> в генераторы Rails, чтобы скрыть от отображения пространство имен текущего генератора при запуске <tt>rails generate</tt>.

* Скаффолды теперь используют +content_tag_for+ в <tt>index.html.erb</tt>.

* Убран <tt>Rails::Plugin</tt>. Вместо добавления плагинов в +vendor/plugins+, используйте гемы, или bundler с путем, или зависимости git.

h4(#railties_deprecations). Устарело

h3. Action Mailer

* Позволяет установить опции Action Mailer по умолчанию с помощью <tt>config.action_mailer.default_options=</tt>.

* Вызывает исключение <tt>ActionView::MissingTemplate</tt>, когда не может быть найден ни один подходящий шаблон.

* Посылает сообщения асинхронно с помощью Rails Queue.

h3. Action Pack

h4. Action Controller

* Добавлен метод <tt>ActionController::Flash.add_flash_types</tt>, чтобы позволить регистрацию собственный типов flash, т.е.:

<ruby>
class ApplicationController
  add_flash_types :error, :warning
end
</ruby>

При добавлении такого кода, можно использовать <tt><%= error %></tt> в erb и <tt>redirect_to /foo, :error => 'message'</tt> в контроллере.

* Из Action Pack убрана зависимость от Active Model.

* Поддержка символов unicode в маршрутах. Маршруты будут автоматически экранироваться, поэтому вместо ручного экранирования:

<ruby>
get Rack::Utils.escape('こんにちは') => 'home#index'
</ruby>

Можно всего лишь написать маршрут в unicode:

<ruby>
get 'こんにちは' => 'home#index'
</ruby>

* Возвращает модходящий формат в исключениях.

* Из <tt>ActionController::ForceSSL::ClassMethods.force_ssl</tt> логика редиректов извлечена в <tt>ActionController::ForceSSL#force_ssl_redirect</tt>.

* Параметры пути URL в неправильной кодировке теперь вызывают <tt>ActionController::BadRequest</tt>.

* Неправильно составленные хэши в строке запроса или в параметрах запроса теперь вызывают <tt>ActionController::BadRequest</tt>.

* +respond_to+ и +respond_with+ теперь вызывают <tt>ActionController::UnknownFormat</tt> вместо непосредственного возврата заголовка 406. Исключение отлавливается и конвертируется в 406 в промежуточной программе обработки исключений.

* JSONP теперь использует <tt>application/javascript</tt> вместо <tt>application/json</tt> в качестве типа MIME.

* Аргументы сессии, переданные в вызовы процесса в функциональных тестах, теперь объединяются с существующей сессией, в то время как раньше они заменяли существующую сессию. Это изменение может сломать некоторые существующие тесты, если они проверяли точный состав сессии, но не сломает существующие тесты, которые проверяли только отдельные ключи.

* Формы для сохраненных записей всегда используют PATCH (с помощью хака +_method+).

* Для ресурсов и PATCH, и PUT ведут на экшн +update+.

* В режиме development не игнорируется +force_ssl+. Это изменение в поведенииThis -- используйте условие <tt>:if</tt>, чтобы восооздать старое поведение.

<ruby>
class AccountsController < ApplicationController
  force_ssl :if => :ssl_configured?

  def ssl_configured?
    !Rails.env.development?
  end
end
</ruby>

h5(#actioncontroller_deprecations). Устарело

* Устарел <tt>ActionController::Integration</tt> в пользу <tt>ActionDispatch::Integration</tt>.

* Устарел <tt>ActionController::IntegrationTest</tt> в пользу <tt>ActionDispatch::IntegrationTest</tt>.

* Устарел <tt>ActionController::PerformanceTest</tt> в пользу <tt>ActionDispatch::PerformanceTest</tt>.

* Устарел <tt>ActionController::AbstractRequest</tt> в пользу <tt>ActionDispatch::Request</tt>.

* Устарел <tt>ActionController::Request</tt> в пользу <tt>ActionDispatch::Request</tt>.

* Устарел <tt>ActionController::AbstractResponse</tt> в пользу <tt>ActionDispatch::Response</tt>.

* Устарел <tt>ActionController::Response</tt> в пользу <tt>ActionDispatch::Response</tt>.

* Устарел <tt>ActionController::Routing</tt> в пользу <tt>ActionDispatch::Routing</tt>.

h4. Action Dispatch

* Показывает маршруты на странице исключения во время отладки <tt>RoutingError</tt> в режиме development.

* Включены по умолчанию <tt>mounted_helpers</tt> (хелперы для доступа к монтируемым engine-ам) в <tt>ActionDispatch::IntegrationTest</tt>.

* Добавлена промежуточная программа <tt>ActionDispatch::SSL</tt>, при включении которой все запросы принуждаются быть под протоколом HTTPS.

* Заполняет определенные маршрутные ограничения значениями по умолчанию, таким образом при генерации url о них известно. Заполняемыми ограничениями являются <tt>:protocol</tt>, <tt>:subdomain</tt>, <tt>:domain</tt>, <tt>:host</tt> и <tt>:port</tt>.

* Позволяет +assert_redirected_to+ соответствовать регулярному выражению.

* Добавлена трассировка на странице ошибки роутинга в режиме development.

* +assert_generates+, +assert_recognizes+ и +assert_routing+ вызывают +Assertion+ вместо +RoutingError+.

* Позволяет маршрутному хелперу root принимать строковый аргумент. Например, <tt>root 'pages#main'</tt> как ярлык для <tt>root to: 'pages#main'</tt>.

* Добавлена поддержка метода PATCH: объекты Request отвечают на <tt>patch?</tt>. В маршрутах теперь имеется новый метод +patch+, и понимается +:patch+ в существующих местах, где настраивается метод, например <tt>:via</tt>. FunctioВ функциональных тестах имеется новый метод +patch+, а в интеграционных тестах имеется новый метод +patch_via_redirect+.

Так как <tt>:patch</tt> является методом по умолчанию для обновлений, правки туннелируются как <tt>PATCH</tt>, а не как <tt>PUT</tt>, и роутинг работает соответственно.

* Интеграционные тесты поддерживают метод OPTIONS.

* +expires_in+ принимает флажок +must_revalidate+. Если true, в заголовок <tt>Cache-Control</tt> добавляется "must-revalidate".

* Default responder will now always use your overridden block in <tt>respond_with</tt> to render your response.

* Выключен многословный режим в <tt>rack-cache</tt>, у нас все еще имеется <tt>X-Rack-Cache</tt> для проверки этой информации.

h5(#actiondispatch_deprecations). Устарело

h4. Action View

* Из Action Pack убрана зависимость от Active Model.

* Разрешено использование <tt>mounted_helpers</tt> (хелперов для доступа к смонтированным engine-ам) в <tt>ActionView::TestCase</tt>.

* Сделаны доступными переменные текущего объекта и счетчика (когда это применимо) при рендеринге шаблонов с помощью <tt>:object</tt> или <tt>:collection</tt>.

* Доступна ленивая загрузка +default_form_builder+ при передаче строки вместо константы.

* Добавлен метод index в класс +FormBuilder+.

* Добавлена поддержка макетов при рендеринге партиала с заданной коллекцией.

* Убран <tt>:disable_with</tt> в пользу опции <tt>data-disable-with</tt> из хелперов +submit_tag+, +button_tag+ и +button_to+.

* Убрана опция <tt>:mouseover</tt> из хелпера +image_tag+.

* Шаблоны без расширения обработчика теперь вызывают предупреждение об устаревании, но все еще по умолчанию +ERb+. В будущих релизах будет просто возвращаться содержимое шаблона.

* В +grouped_options_for_select+ добавлена опция +divider+ для автоматической генерации разделителя групп опций, и устаревает подсказка (prompt) в качестве третьего аргумента в пользу использования хэша опций.

* Добавлены хелперы +time_field+ и +time_field_tag+, которые рендерят тег <tt>input[type="time"]</tt>.

* Убраны старые api +text_helper+ для +highlight+, +excerpt+ и +word_wrap+.

* Убран ведущий \n, добавляемый textarea при +assert_select+.

* Изменено значение по умолчанию для <tt>config.action_view.embed_authenticity_token_in_remote_forms</tt> в false. Это изменение ломает удаленные формы, которые также должны работать без JavaScript, поэтому, если нужно такое поведение, можно либо установить его в true, либо явно передать  <tt>:authenticity_token => true</tt> в опциях формы.

* Стало возможным использовать блок в хелпере +button_to+, если текст кнопки трудно вместить в параметр name:

<ruby>
<%= button_to [:make_happy, @user] do %>
  Make happy <strong><%= @user.name %></strong>
<% end %>
# => "<form method="post" action="/users/1/make_happy" class="button_to">
#      <div>
#        <button type="submit">
#          Make happy <strong>Name</strong>
#        </button>
#      </div>
#    </form>"
</ruby>

* Заменен булев аргумент +include_seconds+ на опцию <tt>:include_seconds => true</tt> в +distance_of_time_in_words+ и +time_ago_in_words+.

* Убраны хелперы +button_to_function+ и +link_to_function+.

* Сейчас +truncate+ всегда возвращает экранированную HTML-безопасную строку. Опция <tt>:escape</tt> может быть использована как +false+, чтобы не экранировать результат.

* Сейчас +truncate+ принимает блок для показа дополнительного содержимого, когда текст обрезается.

* Добавлены хелперы +week_field+, +week_field_tag+, +month_field+, +month_field_tag+, +datetime_local_field+, +datetime_local_field_tag+, +datetime_field+ и +datetime_field_tag+.

* Добавлены хелперы +color_field+ и +color_field_tag+.

* Добавлена опция +include_hidden+ в тег select. С <tt>:include_hidden => false</tt> select с множественными атрибутами не создает скрытое поле с пустым значением.

* Убрана опция size по умолчанию из хелперов +text_field+, +search_field+, +telephone_field+, +url_field+, +email_field+.

* Убраны опции cols и rows по умолчанию из хелпера +text_area+.

* Добавлены +image_url+, +javascript_url+, +stylesheet_url+, +audio_url+, +video_url+ и +font_url+ в хелперы тегов ресурсов. Эти хелперы URL возвратят полный путь к вашим ресурсам. Это полезно, когда вы собираетесь сослаться на этот ресурс с внешнего хоста.

* Позволяет аргументам +value_method+ и +text_method+ из +collection_select+ и +options_from_collection_for_select+ получать объект, отвечающий на <tt>:call</tt>, такой как proc, для вычисления опции в контектсе текущего элемента. Это работает так же, как для +collection_radio_buttons+ и +collection_check_boxes+.

* Добавлены хелперы +date_field+ и +date_field_tag+, которые рендерят тег <tt>input[type="date"]</tt>.

* Добавлен хелпер формы +collection_check_boxes+, похожий на +collection_select+:

<ruby>
collection_check_boxes :post, :author_ids, Author.all, :id, :name
# Выводит что-то наподобие:
<input id="post_author_ids_1" name="post[author_ids][]" type="checkbox" value="1" />
<label for="post_author_ids_1">D. Heinemeier Hansson</label>
<input id="post_author_ids_2" name="post[author_ids][]" type="checkbox" value="2" />
<label for="post_author_ids_2">D. Thomas</label>
<input name="post[author_ids][]" type="hidden" value="" />
</ruby>

Пары label/check_box могут быть настроены в блоке.

* Добавлен хелпер формы +collection_radio_buttons+, похожий на +collection_select+:

<ruby>
collection_radio_buttons :post, :author_id, Author.all, :id, :name
# Выводит что-то наподобие:
<input id="post_author_id_1" name="post[author_id]" type="radio" value="1" />
<label for="post_author_id_1">D. Heinemeier Hansson</label>
<input id="post_author_id_2" name="post[author_id]" type="radio" value="2" />
<label for="post_author_id_2">D. Thomas</label>
</ruby>

Пары label/radio_button могут быть настроены в блоке.

* +check_box+ с атрибутом HTML5 +:form+ теперь будет копировать атрибут +:form+ также в скрытое поле.

* хелпер формы label принимает <tt>:for => nil</tt>, чтобы не генерировать аттрибут.

* Добавлена опция <tt>:format</tt> в +number_to_percentage+.

* Добавлена <tt>config.action_view.logger</tt> для настройки логгера для +Action View+.

* Хелпер +check_box+ с <tt>:disabled => true</tt> теперь создает скрытое +disabled+ поле для приспосабливания к соглашению HTML, что отключенные поля не отправляются формой. Это изменение поведения, раньше скрытый тег имел значение отключенного checkbox.

* Хелпер +favicon_link_tag+ тепрь по умолчанию будет использовать favicon в <tt>app/assets</tt>.

* Теперь <tt>ActionView::Helpers::TextHelper#highlight</tt> по умолчанию элемент HTML5 +mark+.

h5(#actionview_deprecations). Устарело

h4. Sprockets

Перемещены в отдельный гем <tt>sprockets-rails</tt>.

h3. Active Record

* Добавлены выражения схемы <tt>add_reference</tt> и <tt>remove_reference</tt>. Также принимаются псевдонимы <tt>add_belongs_to</tt> и <tt>remove_belongs_to</tt>. Отношения обратимы.

<ruby>
# Создаст столбец user_id
add_reference(:products, :user)

# Создаст столбцы supplier_id, supplier_type и соответствующие индексы
add_reference(:products, :supplier, polymorphic: true, index: true)

# Уберет полиморфное отношение
remove_reference(:products, :supplier, polymorphic: true)
</ruby>

* Добавлены опции <tt>:default</tt> и <tt>:null</tt> в <tt>column_exists?</tt>.

<ruby>
column_exists?(:testings, :taggable_id, :integer, null: false)
column_exists?(:testings, :taggable_type, :string, default: 'Photo')
</ruby>

* <tt>ActiveRecord::Relation#inspect</tt> делает более понятным, что вы работаете с объектом <tt>Relation</tt>, а не с массивом:

<ruby>
User.where(:age => 30).inspect
# => <ActiveRecord::Relation [#<User ...>, #<User ...>]>

User.where(:age => 30).to_a.inspect
# => [#<User ...>, #<User ...>]
</ruby>

если relation возвратит более 10 элементов, inspect покажет только первые 10 и затем многоточие.

* Добавлена поддержка <tt>:collation</tt> и <tt>:ctype</tt> в PostgreSQL. Они доступны для PostgreSQL 8.4 или выше.

<yaml>
development:
  adapter: postgresql
  host: localhost
  database: rails_development
  username: foo
  password: bar
  encoding: UTF8
  collation: ja_JP.UTF8
  ctype: ja_JP.UTF8
</yaml>

* <tt>FinderMethods#exists?</tt> сейчас возвращает <tt>false</tt> с аргументом <tt>false</tt>.

* Добавлена поддержка для определения точности временной метки в адаптере postgresql. Поэтому вместо неправильного определения точности с помощью опции <tt>:limit</tt>, можно по назначению использовать <tt>:precision</tt>. Например, в миграции:

<ruby>
def change
  create_table :foobars do |t|
    t.timestamps :precision => 0
  end
end
</ruby>

* Позволяет <tt>ActiveRecord::Relation#pluck</tt> принимать несколько столбцов. Возвращает массив массивов, содержащих приведенные значения:

<ruby>
Person.pluck(:id, :name)
# SELECT people.id, people.name FROM people
# => [[1, 'David'], [2, 'Jeremy'], [3, 'Jose']]
</ruby>

* Улучшает образование имени соединительной таблицы HABTM, принимая во внимание вложенность. Теперь берутся имена таблиц двух моделей, сортируются по алфавиту и соединяются, отбрасывая любой общий префикс от второго имени таблицы. Несколько примеров:

<plain>
Модели верхнего уровня (Category <=> Product)
Раньше: categories_products
Сейчас: categories_products

Модели верхнего уровня с глобальным global table_name_prefix (Category <=> Product)
Раньше: site_categories_products
Сейчас: site_categories_products

Вложенные модели в модуле без метода table_name_prefix (Admin::Category <=> Admin::Product)
Раньше: categories_products
Сейчас: categories_products

Вложенные модели в модуле с методом table_name_prefix (Admin::Category <=> Admin::Product)
Раньше: categories_products
Сейчас: admin_categories_products

Вложенные модели в родительскую модель (Catalog::Category <=> Catalog::Product)
Раньше: categories_products
Сейчас: catalog_categories_products

Вложенные модели в различные родительские модели (Catalog::Category <=> Content::Page)
Раньше: categories_pages
Сейчас: catalog_categories_content_pages
</plain>

* Проверки валидации HABTM перемещены в <tt>ActiveRecord::Reflection</tt>. Побочным эффектом этого является момент, когда вызываются исключения, он перемещен из точки объявления в точку, где создается связь. Это согласуется с проверками валидации других связей.

* Добавлен хэш <tt>stored_attributes</tt>, содержащий атрибуты, хранящиеся с использованием <tt>ActiveRecord::Store</tt>. Это позволяет получить список атрибутов, которые вы определили.

<ruby>
class User < ActiveRecord::Base
  store :settings, accessors: [:color, :homepage]
end

User.stored_attributes[:settings] # [:color, :homepage]
</ruby>

* <tt>composed_of</tt> был убран. Можете написать свои методы доступа и изменения, если хотите использовать значения объектов для представления некоторых частей ваших моделей. Поэтому вместо:

<ruby>
class Person < ActiveRecord::Base
  composed_of :address, :mapping => [ %w(address_street street), %w(address_city city) ]
end
</ruby>

можно написать что-то наподобие:

<ruby>
def address
  @address ||= Address.new(address_street, address_city)
end

def address=(address)
  self[:address_street] = @address.street
  self[:address_city]   = @address.city

  @address = address
end
</ruby>

* Уровень лога по умоланию для PostgreSQL теперь 'warning', чтобы пропустить шумные сообщения notice. Уровень лога можно изменить с использованием опции <tt>min_messages</tt>, доступной в вашем <tt>config/database.yml</tt>.

* Добавлена поддержка типа данных uuid для адаптера PostgreSQL.

* Был убран <tt>update_attribute</tt>. Используйте <tt>update_column</tt>, если хотите пропустить защиту от массового назначения, валидации, колбэки и затрагивание updated_at. В ином случае используйте <tt>update_attributes</tt>.

* Добавлен <tt>ActiveRecord::Migration.check_pending!</tt>, вызывающий ошибку, если миграции ожидают выполнения.

* Добавлен <tt>#destroy!</tt>, который работает подобно <tt>#destroy</tt>, но вызывает исключение <tt>ActiveRecord::RecordNotDestroyed</tt> вместо возврата <tt>false</tt>.

* Позволяет блок для count с <tt>ActiveRecord::Relation</tt>, для подобия с <tt>Array#count</tt>: <tt>Person.where("age > 26").count { |person| person.gender == 'female' }</tt>

* Добавлена поддержка <tt>CollectionAssociation#delete</tt> для передачи числового или строкового значения как идентификаторы записи. Он находит записи, соответствующие идентификаторам и удаляет их.

<ruby>
class Person < ActiveRecord::Base
  has_many :pets
end

person.pets.delete("1")  # => [#<Pet id: 1>]
person.pets.delete(2, 3) # => [#<Pet id: 2>, #<Pet id: 3>]
</ruby>

* Больше невозможно удалить модель, помеченную как только для чтения.

* В <tt>ActiveRecord::Relation#from</tt> добавлена возможность принимать другие объекты <tt>ActiveRecord::Relation</tt>.

* Добавлена поддержка произвольного кодирования для <tt>ActiveRecord::Store</tt>. Тепрье можно установить собственное кодирование следующим образом:

<ruby>store :settings, accessors: [ :color, :homepage ], coder: JSON</ruby>

* Соединения +mysql+ и +mysql2+ устанавливают по умолчанию <tt>SQL_MODE=STRICT_ALL_TABLES</tt>, чтобы избежать тихой потери данных. Это может быть отключено, определив <tt>strict: false</tt> в <tt>config/database.yml</tt>.

* Добавлено упорядочивание по умолчанию в <tt>ActiveRecord::Base#first</tt> для обеспечения стабильного результата в разных движках баз данных. Представлен <tt>ActiveRecord::Base#take</tt> как замена старому поведению.

* Добавлена опция <tt>:index</tt> для автоматического создания индексов для выражений +references+ и +belongs_to+ в миграциях. Она может быть либо булевым значением, либо хэшем, идентичным опциям, доступным для метода +add_index+:

<ruby>
create_table :messages do |t|
  t.references :person, :index => true
end
</ruby>

То же самое, что и:

<ruby>
create_table :messages do |t|
  t.references :person
end
add_index :messages, :person_id
</ruby>

Генераторы также были обновлены для использования нового синтаксиса.

* Добавлены восклицательные методы для мутации объектов <tt>ActiveRecord::Relation</tt>. Например, если <tt>foo.where(:bar)</tt> возвратит новый объект, оставив foo неизмененным, <tt>foo.where!(:bar)</tt> изменит объект foo.

* Добавлены <tt>#find_by</tt> и <tt>#find_by!</tt> для отражения функционала, предоставляемого динамическими методами поиска, способом, делающим динамический ввод более простым:

<ruby>
Post.find_by name: 'Spartacus', rating: 4
Post.find_by "published_at < ?", 2.weeks.ago
Post.find_by! name: 'Spartacus'
</ruby>

* Добавлен <tt>ActiveRecord::Base#slice</tt>, возвращающий хэш заданных методов с их именами в качестве ключей и возвращенными значениями в качестве значений.

* Убрана IdentityMap -- IdentityMap так и не стала возможностью "включенной по умолчанию", из-за некоторых несоответствий со связями, как объяснено в этом "коммите":https://github.com/rails/rails/commit/302c912bf6bcd0fa200d964ec2dc4a44abe328a6. Таким образом, она убрана из кода, пока некоторые вопросы не будут решены.

* Добавлена возможность для выгрузки/загрузки внутреннего состояния экземпляра +SchemaCache+, так как мы хотим более быструю загрузку, когда имеетмя много моделей.

<ruby>
# запустите таск rake.
RAILS_ENV=production bundle exec rake db:schema:cache:dump
=> generate db/schema_cache.dump

# добавьте config.use_schema_cache_dump = true в config/production.rb. Кстати, true по умолчанию.

# загрузите rails.
RAILS_ENV=production bundle exec rails server
=> use db/schema_cache.dump

# Если нужно убрать выгруженный кеш, запустите таск rake.
RAILS_ENV=production bundle exec rake db:schema:cache:clear
=> remove db/schema_cache.dump
</ruby>

* Добавлена поддержка для частичных индексов в адаптере +PostgreSQL+.

* Метод +add_index+ теперь поддерживает опцию +where+, которая получает строку с критерием частичного индекса.

* Добавлен класс <tt>ActiveRecord::NullRelation</tt>, реализующий паттерн нулевого объекта для класса Relation.

* Реализован метод <tt>ActiveRecord::Relation#none</tt>, возвращающий сцепливаемый relation с нулем записей (экземпляр класса +NullRelation+). Любое последующее условие, прицепленное к возвращенному relation, будет продолжать создавать пустой relation, и не будет передавать какие-либо запросы в базу данных.

* Добавлен миграционный хелпер +create_join_table+ для создания соединительных таблиц HABTM.

<ruby>
create_join_table :products, :categories
# =>
# create_table :categories_products, :id => false do |td|
#   td.integer :product_id, :null => false
#   td.integer :category_id, :null => false
# end
</ruby>

* Первичный ключ всегда инициализируется в хэше +@attributes+ как nil (пока не будет определено другое значение).

* В предыдущих релизах следующее создавало один запрос с OUTER JOIN comments, а не два отдельных запроса:

<ruby>Post.includes(:comments).where("comments.name = 'foo'")</ruby>

Это поведение полагалось на соответствии строки SQL, что было изначально порочной идеей, пока мы не написали парсер SQL, что мы не хотели делать. Следовательно, это устарело.

Чтобы избежать предупрежедний об устаревании и для будущей совместимости, нужно явно отметить, на какие таблицы вы ссылаетесь при использовании фрагмента SQL:

<ruby>Post.includes(:comments).where("comments.name = 'foo'").references(:comments)</ruby>

Отметьте, что в следующих случаях не нужно явно определять ссылки, так как они автоматически подразумеваются:

<ruby>
Post.where(comments: { name: 'foo' })
Post.where('comments.name' => 'foo')
Post.order('comments.name')
</ruby>

Также об этом не нужно беспокоитсья, если вы не делаете ленивой загружки. В общем, не беспокойтесь, если не увидите предупреждения об устарении или (в будущих релизах) ошибки SQL об отсутствующем JOIN.

* Поддержка таблицы +schema_info+ была удалена. Переключитесь на +schema_migrations+.

* Соединения *должны* быть закрыты в конце треда. Если не так, ваш пул подключений переполнится и будет вызвано исключение.

* Добавлен модуль <tt>ActiveRecord::Model</tt>, который может быть включен в класс, как альтернатива наследованию от <tt>ActiveRecord::Base</tt>:

<ruby>
class Post
  include ActiveRecord::Model
end
</ruby>

* Могут быть созданы записи PostgreSQL hstore.

* Тип PostgreSQL hstore автоматически десериализуется из базы данных.

h4(#activerecord_deprecations). Устарело

* Устарело большинство из методов 'динамического поиска'. Все динамические методы, кроме +find_by_...+ и +find_by_...!+ устарели. Вот как можно переписать код:

<ruby>
find_all_by_... может быть переписан с использованием where(...)
find_last_by_... может быть переписан с использованием where(...).last
scoped_by_... может быть переписан с использованием where(...)
find_or_initialize_by_... может быть переписан с использованием where(...).first_or_initialize
find_or_create_by_... может быть переписан с использованием where(...).first_or_create
find_or_create_by_...! может быть переписан с использованием where(...).first_or_create!
</ruby>

Реализация устаревших динамических методов поиска была перемещена в гем +active_record_deprecated_finders+.

* Устарел старый API поиска, основанный на хэше. Это означает, что методы, ранее принимающие "опции поиска", больше так не делают. Например, это:

<ruby>Post.find(:all, :conditions => { :comments_count => 10 }, :limit => 5)</ruby>

должно быть переписано в новом стиле, появившемся в Rails 3:

<ruby>Post.where(comments_count: 10).limit(5)</ruby>

Отметьте, что как промежуточный шаг, возможно переписать вышеуказанное как:

<ruby>Post.scoped(:where => { :comments_count => 10 }, :limit => 5)</ruby>

Это сможет спасти вам много времени, если в вашем приложении много использования методов поиска в старом стиле.

Вызов <tt>Post.scoped(options)</tt> это ярлык для <tt>Post.scoped.merge(options)</tt>. <tt>Relation#merge</tt> теперь принимает хэш опций, но они должны быть идентичны именам соответствующих методов поиска. Они в основном такие же, как имена опций поиска старого стиля, за исключением следующих случаев:

<plain>
:conditions стал :where
:include стал :includes
:extend стал :extending
</plain>

Код, реализующий устаревшие возможности, был перемещен в гем +active_record_deprecated_finders+. Этот гем является зависимостью для Active Record в Rails 4.0. Он больше не будет зависимостью, начиная с Rails 4.1, но если ваше приложение полагается на устаревшие возможности, его можно добавить в ваш Gemfile. Он будет поддерживаться командой Rails до того момента, пока не выйдет Rails 5.0.

* Устарели лениво вычисляемые скоупы.

  Не используйте это:

<ruby>
scope :red, where(color: 'red')
default_scope where(color: 'red')
</ruby>

  Используйте это:

<ruby>
scope :red, -> { where(color: 'red') }
default_scope { where(color: 'red') }
</ruby>

  Предшествующий вариант имел ряд вопросов. Наиболее обычным для новичков был следующим:

<ruby>
scope :recent, where(published_at: Time.now - 2.weeks)
</ruby>

  Или более утонченный вариант:

<ruby>
scope :recent, -> { where(published_at: Time.now - 2.weeks) }
scope :recent_red, recent.where(color: 'red')
</ruby>

  Ленивые скоупы были также очень сложно реализованы в Active Record, и там всегда были баги. Например, делает не то, что от него ожидается:

<ruby>
scope :remove_conditions, except(:where)
where(...).remove_conditions # => все еще есть условие
</ruby>

* Устарела опция связей :dependent => :restrict.

* До сих пор в has_many и has_one, опция :dependent => :restrict вызывала DeleteRestrictionError во время уничтожения объекта. Вместо этого, она будет добавлять ошибку в модель.

* Чтобы исправить это предупреждение, убедитесь, что ваш код не полагается на DeleteRestrictionError, и затем добавьте config.active_record.dependent_restrict_raises = false в конфиг вашего приложения.

* Новое приложение rails будет создано с config.active_record.dependent_restrict_raises = false в конфиге приложения.

* Генератор миграции теперь создает соединительную таблицу с (закомментированными) индексами каждый раз, когда имя миграции содержит слово "join_table".

h3. Active Model

* Изменено значение по умолчанию <tt>AM::Serializers::JSON.include_root_in_json</tt> в false. Теперь, у сериализаторов AM и объектов AR одинаковое поведение.

<ruby>
class User < ActiveRecord::Base; end

class Person
  include ActiveModel::Model
  include ActiveModel::AttributeMethods
  include ActiveModel::Serializers::JSON

  attr_accessor :name, :age

  def attributes
    instance_values
  end
end

user.as_json
=> {"id"=>1, "name"=>"Konata Izumi", "age"=>16, "awesome"=>true}
# root is not included

person.as_json
=> {"name"=>"Francesco", "age"=>22}
# root is not included
</ruby>

* Передача значений false в хэше в +validates+ больше не будет включать соответствующие валидаторы.

* Сообщения об ошибке +ConfirmationValidator+ будут присоединяться к <tt>:#{attribute}_confirmation</tt> вместо +attribute+.

* Добавлен <tt>ActiveModel::Model</tt>, примесь, чтобы объекты Ruby могли работать с Action Pack "из коробки".

* <tt>ActiveModel::Errors#to_json</tt> Поддерживает новый параметр <tt>:full_messages</tt>.

* Урезано API удалением <tt>valid?</tt> и <tt>errors.full_messages</tt>.

h4(#activemodel_deprecations). Устарело

h3. Active Resource

* Active Resource удален из Rails 4.0, и теперь это отдельный "гем":https://github.com/rails/activeresource.

h3. Active Support

* Теперь <tt>Time#change</tt> работает со значениями времени со смещениями иными, чем UTC или текущая временная зона.

* Добавлены <tt>Time#prev_quarter</tt> и <tt>Time#next_quarter</tt> как методы-сокращения для <tt>months_ago(3)</tt> and <tt>months_since(3)</tt>.

* Убран устаревший и неиспользуемый метод <tt>require_association</tt> из зависимостей.

* Добавлена опция <tt>:instance_accessor</tt> для <tt>config_accessor</tt>.

<ruby>
class User
  include ActiveSupport::Configurable
  config_accessor :allowed_access, instance_accessor: false
end

User.new.allowed_access = true # => NoMethodError
User.new.allowed_access        # => NoMethodError
</ruby>

* Методы <tt>ActionView::Helpers::NumberHelper</tt> были перемещены в <tt>ActiveSupport::NumberHelper</tt>, и теперь доступны с помощью <tt>Numeric#to_s</tt>.

* <tt>Numeric#to_s</tt> теперь принимает опции форматирования :phone, :currency, :percentage, :delimited, :rounded, :human и :human_size.

* Добавлены <tt>Hash#transform_keys</tt>, <tt>Hash#transform_keys!</tt>, <tt>Hash#deep_transform_keys</tt> и <tt>Hash#deep_transform_keys!</tt>.

* Изменен тип xml datetime на dateTime (с заглавной буквой T).

* Добавлена опция <tt>:instance_accessor</tt> для <tt>class_attribute</tt>.

* Теперь +constantize+ ищет в цепочке предков.

* Добавлены <tt>Hash#deep_stringify_keys</tt> и <tt>Hash#deep_stringify_keys!</tt> для конвертации всех ключей из экземпяра +Hash+ в строки.

* Добавлены <tt>Hash#deep_symbolize_keys</tt> и <tt>Hash#deep_symbolize_keys!</tt> для конвертации всех ключей из экземпяра +Hash+ в символы.

* <tt>Object#try</tt> не вызывает приватные методы.

* В AS::Callbacks#run_callbacks убран аргумент ключа.

* Теперь +deep_dup+ works работает более предсказуемо и также дублирует значения в экземплярах +Hash+ и элементы в экземплярах +Array+.

* Inflector больше не применяет ice -> ouse к словам, таким как slice, police.

* Добавлена <tt>ActiveSupport::Deprecations.behavior = :silence</tt> для полного игнорирования устареваний Rails во время выполнения.

* <tt>Module#delegate</tt> может остановить использование send -- больше не поддерживаетс делегация приватных методов.

* В AS::Callbacks устарела опция :rescuable.

* Добавлен <tt>Integer#ordinal</tt>, чтобы получить порядковый суффикс для числа.

* В AS::Callbacks опция :per_key больше не поддерживается.

* В AS::Callbacks#define_callbacks добавлена опция :skip_after_callbacks_if_terminated.

* Добавлен html_escape_once в ERB::Util, и хелпер тега escape_once делегирован на него.

* Убран метод <tt>ActiveSupport::TestCase#pending</tt>, используйте вместо него +skip+.

* Удален метод совместимости <tt>Module#method_names</tt>, с этого момента используйте <tt>Module#methods</tt> (который возвращает символы).

* Удален метод совместимости <tt>Module#instance_method_names</tt>, с этого момента используйте <tt>Module#instance_methods</tt> (который возвращает символы).

* База данных Unicode обновлена до 6.1.0.

* Добавлена опция +encode_big_decimal_as_string+ для принуждения сериализации JSON для BigDecimals как числового значения вместо оборачивания их в строки для безопасности.

h4(#activesupport_deprecations). Устарело

* <tt>ActiveSupport::Callbacks</tt>: устарело использование объекта фильтра с методами <tt>#before</tt> и <tt>#after</tt> как колбэка <tt>around</tt>.

* Устарел <tt>BufferedLogger</tt>. Используйте <tt>ActiveSupport::Logger</tt> или +logger+ из Ruby stdlib.

* Устарел метод совместимости <tt>Module#local_constant_names</tt>, используйте вместо него <tt>Module#local_constants</tt> (который возвращает символы).
