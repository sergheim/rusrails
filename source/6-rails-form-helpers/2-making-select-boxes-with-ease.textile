h1. Легкое создание списков выбора

Списки выбора в HTML требуют значительной верстки (один элемент +OPTION+ для каждого варианта выбора), поэтому имеет большой смысл создавать их динамически.

Вот как может выглядеть верстка:

<html>
<select name="city_id" id="city_id">
  <option value="1">Lisbon</option>
  <option value="2">Madrid</option>
  ...
  <option value="12">Berlin</option>
</select>
</html>

Тут мы имеем перечень городов, имена которых представлены пользователю. Самому приложению для обработки нужен только их ID, поэтому он используется как атрибут value варианта выбора. Давайте посмотрим, как Rails может нам помочь.

h4. Тэги Select и Option

Наиболее простой хелпер -- это +select_tag+, который, как следует из имени, просто создает тег +SELECT+, инкапсулирующий строку опций:

<erb>
<%= select_tag(:city_id, '<option value="1">Lisbon</option>...') %>
</erb>

Это закладывает начало, но пока еще динамически не создает теги вариантов выбора. Вы можете создать теги option с помощью хелпера +options_for_select+:

<erb>
<%= options_for_select([['Lisbon', 1], ['Madrid', 2], ...]) %>

результат:

<option value="1">Lisbon</option>
<option value="2">Madrid</option>
...
</erb>

Первый аргумент для +options_for_select+ -- это вложенный массив, в котором каждый элемент содержит два элемента: текст варианта (название города) и значение варианта (id города). Значение варианта -- это то, что будет передано в ваш контроллер. Часто бывает, что значение -- это id соответствующего объекта базы данных, но это не всегда так.

Зная это, вы можете комбинировать +select_tag+ и +options_for_select+ для достижения желаемой полной верстки:

<erb>
<%= select_tag(:city_id, options_for_select(...)) %>
</erb>

+options_for_select+ позволяет вам предварительно выбрать вариант, передав его значение.

<erb>
<%= options_for_select([['Lisbon', 1], ['Madrid', 2], ...], 2) %>

результат:

<option value="1">Lisbon</option>
<option value="2" selected="selected">Madrid</option>
...
</erb>

Всякий раз, когда Rails видит внутреннее значение создаваемого варианта, соответствующего этому значению, он добавит атрибут +selected+ к нему.

TIP: Второй аргумент для +options_for_select+ должен быть точно равен желаемому внутреннему значению. В частности, если значение -- число 2, вы не можете передать "2" в +options_for_select+ -- вы должны передать 2. Имейте это в виду при использовании значений, извлеченных из хэша +params+, так как они всегда строчные.

WARNING: Когда отсутствует +:inlude_blank+ или +:prompt:+, +:include_blank+ становится true, если атрибут +required+ true, отображаемый +size+ 1 и +multiple+ не true.

С помощью хэшей можно добавить произвольные атрибуты в option:

<erb>
<%= options_for_select([['Lisbon', 1, :'data-size' => '2.8 million'], ['Madrid', 2, :'data-size' => '3.2 million']], 2) %>

результат:

<option value="1" data-size="2.8 million">Lisbon</option>
<option value="2" selected="selected" data-size="3.2 million">Madrid</option>
...
</erb>

h4. Списки выбора для работы с моделями

В большинстве случаев элементы управления формой будут связаны с определенной моделью базы данных, и, как вы наверное и ожидали, Rails предоставляет хелперы, предназначенные для этой цели. Как в случае с другими хелперами форм, когда работаете с моделями, суффикс +_tag+ отбрасывается от +select_tag+:

<ruby>
# контроллер:
@person = Person.new(:city_id => 2)
</ruby>

<erb>
# вьюха:
<%= select(:person, :city_id, [['Lisbon', 1], ['Madrid', 2], ...]) %>
</erb>

Отметьте, что третий параметр -- массив опций -- имеет тот же самый тип аргумента, что мы передавали в +options_for_select+. Преимущество в том, что не стоит беспокоиться об предварительном выборе правильного города, если пользователь уже выбрал его - Rails сделает это за вас, прочитав из атрибута +@person.city_id+.

Как и в других хелперах, если хотите использовать хелпер +select+ в form builder с областью видимостью объекта +@person+, синтаксис будет такой:

<erb>
# select в form builder
<%= f.select(:city_id, ...) %>
</erb>

WARNING: При использовании +select+ (или подобного хелпера, такого как +collection_select+, +select_tag+), чтобы установить связь +belongs_to+, вы должны передасть имя внешнего ключа (в примере выше +city_id+), а не само имя связи. Если определите +city+ вместо +city_id+, Active Record вызовет ошибку в строке +ActiveRecord::AssociationTypeMismatch: City(#17815740) expected, got String(#1138750)+, когда вы передадите хэш +params+ в +Person.new+ или +update_attributes+. Можно взглянуть на это по другому, что хелперы форм редактируют только атрибуты. Также вам стоит знать о потенциальных последствиях безопасности, если разрешить пользователям редактировать внешние ключи напрямую. Возможно вы захотите использовть +attr_protected+ и +attr_accessible+. Более подробно об этом читайте в "Руководстве Ruby On Rails по безопасности":/ruby-on-rails-security-guide/mass-assignment.

h4. Тэги варианта выбора из коллекции произвольных объектов

Создание тегов вариантов с помощью +options_for_select+ требует, чтобы вы создали массив, содержащий текст и значение для каждого варианта. Но что, если мы имеем модель City (вероятно даже модель Active Record) и хотим создать теги вариантов из коллекции этих объектов? Одно из решений будет сделать вложенный массив с помощью итераций:

<erb>
<% cities_array = City.all.map { |city| [city.name, city.id] } %>
<%= options_for_select(cities_array) %>
</erb>

Хотя это и валидное решение, но Rails предоставляет менее многословную альтернативу: +options_from_collection_for_select+. Этот хелпер принимает коллекцию произвольных объектов и два дополнительных аргумента -- имена методов для считывания опций *value* и *text*, соответственно:

<erb>
<%= options_from_collection_for_select(City.all, :id, :name) %>
</erb>

Как следует из имени, это генерирует только теги option. Для генерации работающего списка выбора его необходимо использовать в сочетании с +select_tag+, как это делалось для +options_for_select+. Когда работаем с объектами модели, так же, как +select+ комбинирует +select_tag+ и +options_for_select+, +collection_select+ комбинирует +select_tag+ с +options_from_collection_for_select+.

<erb>
<%= collection_select(:person, :city_id, City.all, :id, :name) %>
</erb>

Напомним, что +options_from_collection_for_select+ в +collection_select+ -- то же самое, что и +options_for_select+ в +select+.

NOTE: Пары, переданные в +options_for_select+ должны сперва иметь имя, затем id, однако для +options_from_collection_for_select+ первый аргумент -- это метод значения, а второй аргумент - метод текста.

h4. Выбор часового пояса и страны

Для управления поддержкой часовых поясов в Rails, можете спрашивать своих пользователей, в какой зоне они находятся. Это потребует создать варианты выбора из списка предопределенных объектов TimeZone, используя +collection_select+, но вы можете просто использовать хелпер +time_zone_select+, который уже все это содержит:

<erb>
<%= time_zone_select(:person, :time_zone) %>
</erb>

Также есть хелпер +time_zone_options_for_select+ для ручного (и поэтому гибко настраиваемого) способа осуществления этого. Читайте документацию по API, чтобы узнать о доступных аргументах для этих двух методов.

Rails _раньше_ имел хелпер +country_select+ для выбора стран, но сейчас он вынесен во внешний "плагин country_select":http://github.com/rails/country_select/tree/master. При его использовании убедитесь, что включение или исключение определенных имен из списка может быть несколько спорным (это и послужило причиной извлечения этой функциональности из Rails).
